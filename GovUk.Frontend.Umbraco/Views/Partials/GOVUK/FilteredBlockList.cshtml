@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<FilteredBlockListModel>
@using GovUk.Frontend.Umbraco.Models
@using System.Text.RegularExpressions
@using GovUk.Frontend.Umbraco.Services
@using Umbraco.Extensions
@{
    var blocks = Model.FilteredBlocks().ToList();
    if (!blocks.Any()) { return; }
    string? previousRowClass = null, previousColumnClass = null;
    bool? previousIsGridRowBlock = null;
}
@* Renders a partial view for each block.
   Renders blocks within a GOV.UK grid row, except where that block is a 'govukGridRow' in which case that task is delegated.
   Combines sibling rows with identical classes to simplify the HTML, but also to reduce instances where the grid rows 
   interfere with the spacing between components. Spacing (particularly for inset text) can rely on margin collapsing and
   wrapping every component in a grid row prevents that from working because the components no longer directly follow each other.
*@
@for (var i = 0; i < blocks.Count; i++)
{
    if (blocks[i]?.ContentUdi == null) { continue; }

    var block = blocks[i] is FilteredBlockListItem ? blocks[i] : new FilteredBlockListItem(blocks[i], Model.Filter);

    var isGridRowBlock = blocks[i].Content.ContentType.Alias == "govukGridRow";
    string rowClass = GovUkGridClassBuilder.BuildGridRowClass(blocks[i].Settings?.Value<string>("cssClassesForRow"));
    var columnClass = GovUkGridClassBuilder.BuildGridColumnClass(
                        blocks[i].Settings?.Value<string>("columnSize"), 
                        blocks[i].Settings?.Value<string>("columnSizeFromDesktop"), 
                        blocks[i].Settings?.Value<string>("cssClassesForColumn"));

    var sameAsPrevious = (isGridRowBlock == previousIsGridRowBlock && rowClass == previousRowClass && columnClass == previousColumnClass);

    var sameAsNext = (i < blocks.Count-1 &&
                          isGridRowBlock == (blocks[i + 1].Content.ContentType.Alias == "govukGridRow") &&
                          rowClass == GovUkGridClassBuilder.BuildGridRowClass(blocks[i+1].Settings?.Value<string>("cssClassesForRow")) &&
                          columnClass == GovUkGridClassBuilder.BuildGridColumnClass(
                                                    blocks[i+1].Settings?.Value<string>("columnSize"), 
                                                    blocks[i+1].Settings?.Value<string>("columnSizeFromDesktop"), 
                                                    blocks[i+1].Settings?.Value<string>("cssClassesForColumn")));

    @if (Model.RenderGrid && !isGridRowBlock && !sameAsPrevious) { 
        @:<div class="@rowClass"> 
        @:<div class="@columnClass"> 
    }
    @await Html.PartialAsync("GOVUK/" + blocks[i].Content.ContentType.Alias, block)
    @if (Model.RenderGrid && !isGridRowBlock && !sameAsNext) {
        @:</div> 
        @:</div> 
    }

    previousIsGridRowBlock = isGridRowBlock;
    previousRowClass = rowClass;
    previousColumnClass = columnClass;
}